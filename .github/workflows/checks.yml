name: checks

on:
  push:
    branches:
      - main
  pull_request: {}
  workflow_dispatch: {}

concurrency:
  group: checks-${{ github.ref }}
  cancel-in-progress: true

jobs:
  Tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          ./.devcontainer/install-tools.sh
          yarn
        env:
          SKIP_FOUNDRY: 1
      - name: Lint
        run: |
          yarn fmt
          yarn lint
      - name: Start zksync service
        run: |
          docker compose up zksync &
      - name: Wait for zksync service to be ready
        run: |
          echo "Waiting for zksync to be up..."
          while ! nc -z localhost 3050 || ! nc -z localhost 8545; do
            echo "zksync is not yet running, waiting..."
            sleep 10
          done
          echo "zksync ports are up! Just wait an extra 1 minutes to be sure..."
          sleep 60
      - name: Run tests
        run: yarn test