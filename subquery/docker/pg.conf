# Memory configuration - Total 4GB RAM
shared_buffers = 512MB                  # 12.5% of RAM
work_mem = 16MB                         # Conservative for multiple connections
maintenance_work_mem = 64MB             # For maintenance operations
effective_cache_size = 1536MB           # ~38% of RAM (leaving room for OS and other processes)
temp_buffers = 8MB                      # Reduced for temp operations

# Connection and worker settings - 4vCPU (2 cores)
max_connections = 20                    # Reduced to save memory
max_worker_processes = 2                # One per physical core
max_parallel_workers_per_gather = 1     # Conservative parallel operations
max_parallel_workers = 2                # Match physical cores
dynamic_shared_memory_type = posix      # Default for Linux

# Query tuning
random_page_cost = 1.1                 # Optimized for SSD
effective_io_concurrency = 100         # Good for SSD
parallel_tuple_cost = 0.2              # Default
parallel_setup_cost = 1000             # Default

# Resource usage
work_mem = 16MB                        # Per operation memory
maintenance_work_mem = 64MB            # For maintenance tasks
autovacuum_work_mem = 32MB            # For autovacuum operations
max_stack_depth = 2MB                  # Default

# Background writer
bgwriter_delay = 200ms                 # Conservative
bgwriter_lru_maxpages = 100           # Conservative
bgwriter_lru_multiplier = 2.0         # Default

# Autovacuum settings - Conservative
autovacuum = on
autovacuum_max_workers = 1            # Limited due to CPU constraints
autovacuum_naptime = 60s              # Less frequent checks
autovacuum_vacuum_threshold = 50      # Default
autovacuum_vacuum_scale_factor = 0.1  # Less aggressive
autovacuum_analyze_threshold = 50     # Default
autovacuum_analyze_scale_factor = 0.05
vacuum_cost_delay = 2ms               # Small delay between operations
vacuum_cost_limit = 200               # Default

# WAL and checkpoints - Conservative
checkpoint_timeout = 15min
checkpoint_completion_target = 0.9
max_wal_size = 1GB
min_wal_size = 512MB
wal_buffers = 16MB                    # Default is -1 (auto)

# Query planning
cpu_tuple_cost = 0.03                 # Default
cpu_index_tuple_cost = 0.005         # Default
cpu_operator_cost = 0.0025           # Default
geqo_threshold = 12                   # Default

# Memory pressure settings
huge_pages = off                      # Usually off by default
temp_file_limit = 1GB                # Limit temp file size

# Logging
logging_collector = on
log_min_duration_statement = 1000     # Log slow queries (1s)
log_checkpoints = on
log_connections = off                 # Reduce logging overhead
log_disconnections = off              # Reduce logging overhead
log_lock_waits = on                  # Important for debugging
log_temp_files = 0                   # Log all temp files
log_autovacuum_min_duration = 1000   # Log long autovacuum operations

# Extensions
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.max = 5000        # Reduced from 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = off

# Query optimization
jit = off                            # Disabled to reduce CPU pressure
random_page_cost = 1.1               # Good for SSD
effective_io_concurrency = 100       # Good for SSD

# Additional settings for limited resources
track_activities = off               # Reduce overhead
track_counts = off                   # Reduce overhead
track_io_timing = off               # Reduce overhead
track_functions = none              # Reduce overhead